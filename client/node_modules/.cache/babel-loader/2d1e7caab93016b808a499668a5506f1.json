{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst errors_1 = require(\"@oclif/errors\");\n\nconst path = require(\"path\");\n\nconst util_1 = require(\"util\");\n\nconst command_1 = require(\"./command\");\n\nconst debug_1 = require(\"./debug\");\n\nconst ts_node_1 = require(\"./ts-node\");\n\nconst util_2 = require(\"./util\");\n\nconst ROOT_INDEX_CMD_ID = '';\n\nconst _pjson = require('../package.json');\n\nconst hasManifest = function (p) {\n  try {\n    require(p);\n\n    return true;\n  } catch (_a) {\n    return false;\n  }\n};\n\nfunction topicsToArray(input, base) {\n  if (!input) return [];\n  base = base ? `${base}:` : '';\n\n  if (Array.isArray(input)) {\n    return input.concat(util_2.flatMap(input, t => topicsToArray(t.subtopics, `${base}${t.name}`)));\n  }\n\n  return util_2.flatMap(Object.keys(input), k => {\n    input[k].name = k;\n    return [Object.assign(Object.assign({}, input[k]), {\n      name: `${base}${k}`\n    })].concat(topicsToArray(input[k].subtopics, `${base}${input[k].name}`));\n  });\n} // eslint-disable-next-line valid-jsdoc\n\n/**\n * find package root\n * for packages installed into node_modules this will go up directories until\n * it finds a node_modules directory with the plugin installed into it\n *\n * This is needed because of the deduping npm does\n */\n\n\nasync function findRoot(name, root) {\n  // essentially just \"cd ..\"\n  function* up(from) {\n    while (path.dirname(from) !== from) {\n      yield from;\n      from = path.dirname(from);\n    }\n\n    yield from;\n  }\n\n  for (const next of up(root)) {\n    let cur;\n\n    if (name) {\n      cur = path.join(next, 'node_modules', name, 'package.json'); // eslint-disable-next-line no-await-in-loop\n\n      if (await util_2.exists(cur)) return path.dirname(cur);\n\n      try {\n        // eslint-disable-next-line no-await-in-loop\n        const pkg = await util_2.loadJSON(path.join(next, 'package.json'));\n        if (pkg.name === name) return next;\n      } catch (_a) {}\n    } else {\n      cur = path.join(next, 'package.json'); // eslint-disable-next-line no-await-in-loop\n\n      if (await util_2.exists(cur)) return path.dirname(cur);\n    }\n  }\n}\n\nclass Plugin {\n  // eslint-disable-next-line no-useless-constructor\n  constructor(options) {\n    this.options = options; // static loadedPlugins: {[name: string]: Plugin} = {}\n\n    this._base = `${_pjson.name}@${_pjson.version}`;\n    this.valid = false;\n    this.alreadyLoaded = false;\n    this.children = []; // eslint-disable-next-line new-cap\n\n    this._debug = debug_1.default();\n    this.warned = false;\n  }\n\n  async load() {\n    this.type = this.options.type || 'core';\n    this.tag = this.options.tag;\n    const root = await findRoot(this.options.name, this.options.root);\n    if (!root) throw new Error(`could not find package.json with ${util_1.inspect(this.options)}`);\n    this.root = root;\n\n    this._debug('reading %s plugin %s', this.type, root);\n\n    this.pjson = await util_2.loadJSON(path.join(root, 'package.json'));\n    this.name = this.pjson.name;\n    const pjsonPath = path.join(root, 'package.json');\n    if (!this.name) throw new Error(`no name in ${pjsonPath}`);\n    const isProd = hasManifest(path.join(root, 'oclif.manifest.json'));\n    if (!isProd && !this.pjson.files) this.warn(`files attribute must be specified in ${pjsonPath}`); // eslint-disable-next-line new-cap\n\n    this._debug = debug_1.default(this.name);\n    this.version = this.pjson.version;\n\n    if (this.pjson.oclif) {\n      this.valid = true;\n    } else {\n      this.pjson.oclif = this.pjson['cli-engine'] || {};\n    }\n\n    this.hooks = util_2.mapValues(this.pjson.oclif.hooks || {}, i => Array.isArray(i) ? i : [i]);\n    this.manifest = await this._manifest(Boolean(this.options.ignoreManifest), Boolean(this.options.errorOnManifestCreate));\n    this.commands = Object.entries(this.manifest.commands).map(([id, c]) => Object.assign(Object.assign({}, c), {\n      load: () => this.findCommand(id, {\n        must: true\n      })\n    }));\n    this.commands.sort((a, b) => {\n      if (a.id < b.id) return -1;\n      if (a.id > b.id) return 1;\n      return 0;\n    });\n  }\n\n  get topics() {\n    return topicsToArray(this.pjson.oclif.topics || {});\n  }\n\n  get commandsDir() {\n    return ts_node_1.tsPath(this.root, this.pjson.oclif.commands);\n  }\n\n  get commandIDs() {\n    if (!this.commandsDir) return [];\n    let globby;\n\n    try {\n      const globbyPath = require.resolve('globby', {\n        paths: [this.root, __dirname]\n      });\n\n      globby = require(globbyPath);\n    } catch (error) {\n      this.warn(error, 'not loading commands, globby not found');\n      return [];\n    }\n\n    this._debug(`loading IDs from ${this.commandsDir}`);\n\n    const patterns = ['**/*.+(js|ts|tsx)', '!**/*.+(d.ts|test.ts|test.js|spec.ts|spec.js)?(x)'];\n    const ids = globby.sync(patterns, {\n      cwd: this.commandsDir\n    }).map(file => {\n      const p = path.parse(file);\n      const topics = p.dir.split('/');\n      const command = p.name !== 'index' && p.name; // support src/commands/index as a \"root\" command\n\n      if (!command && this.type === 'core' && p.dir.length === 0 && p.name === 'index') return ROOT_INDEX_CMD_ID;\n      return [...topics, command].filter(f => f).join(':');\n    });\n\n    this._debug('found commands', ids);\n\n    return ids;\n  }\n\n  findCommand(id, opts = {}) {\n    const fetch = () => {\n      if (!this.commandsDir) return;\n\n      const search = cmd => {\n        if (typeof cmd.run === 'function') return cmd;\n        if (cmd.default && cmd.default.run) return cmd.default;\n        return Object.values(cmd).find(cmd => typeof cmd.run === 'function');\n      };\n\n      const p = require.resolve(path.join(this.commandsDir, ...id.split(':')));\n\n      this._debug('require', p);\n\n      let m;\n\n      try {\n        m = require(p);\n      } catch (error) {\n        if (!opts.must && error.code === 'MODULE_NOT_FOUND') return;\n        throw error;\n      }\n\n      const cmd = search(m);\n      if (!cmd) return;\n      cmd.id = id;\n      cmd.plugin = this;\n      return cmd;\n    };\n\n    const cmd = fetch();\n    if (!cmd && opts.must) errors_1.error(`command ${id} not found`);\n    return cmd;\n  }\n\n  async _manifest(ignoreManifest, errorOnManifestCreate = false) {\n    const readManifest = async (dotfile = false) => {\n      try {\n        const p = path.join(this.root, `${dotfile ? '.' : ''}oclif.manifest.json`);\n        const manifest = await util_2.loadJSON(p);\n\n        if (!process.env.OCLIF_NEXT_VERSION && manifest.version.split('-')[0] !== this.version.split('-')[0]) {\n          process.emitWarning(`Mismatched version in ${this.name} plugin manifest. Expected: ${this.version} Received: ${manifest.version}\\nThis usually means you have an oclif.manifest.json file that should be deleted in development. This file should be automatically generated when publishing.`);\n        } else {\n          this._debug('using manifest from', p);\n\n          return manifest;\n        }\n      } catch (error) {\n        if (error.code === 'ENOENT') {\n          if (!dotfile) return readManifest(true);\n        } else {\n          this.warn(error, 'readManifest');\n        }\n      }\n    };\n\n    if (!ignoreManifest) {\n      const manifest = await readManifest();\n      if (manifest) return manifest;\n    }\n\n    return {\n      version: this.version,\n      // eslint-disable-next-line array-callback-return\n      commands: this.commandIDs.map(id => {\n        try {\n          return [id, command_1.Command.toCached(this.findCommand(id, {\n            must: true\n          }), this)];\n        } catch (error) {\n          const scope = 'toCached';\n          if (Boolean(errorOnManifestCreate) === false) this.warn(error, scope);else throw this.addErrorScope(error, scope);\n        }\n      }).filter(f => Boolean(f)).reduce((commands, [id, c]) => {\n        commands[id] = c;\n        return commands;\n      }, {})\n    };\n  }\n\n  warn(err, scope) {\n    if (this.warned) return;\n    if (typeof err === 'string') err = new Error(err);\n    process.emitWarning(this.addErrorScope(err, scope));\n  }\n\n  addErrorScope(err, scope) {\n    err.name = `${err.name} Plugin: ${this.name}`;\n    err.detail = util_2.compact([err.detail, `module: ${this._base}`, scope && `task: ${scope}`, `plugin: ${this.name}`, `root: ${this.root}`, 'See more details with DEBUG=*']).join('\\n');\n    return err;\n  }\n\n}\n\nexports.Plugin = Plugin;","map":{"version":3,"sources":["C:/Users/Mdp79/Desktop/04-Supplemental/giphtionary/node_modules/@oclif/config/lib/plugin.js"],"names":["Object","defineProperty","exports","value","errors_1","require","path","util_1","command_1","debug_1","ts_node_1","util_2","ROOT_INDEX_CMD_ID","_pjson","hasManifest","p","_a","topicsToArray","input","base","Array","isArray","concat","flatMap","t","subtopics","name","keys","k","assign","findRoot","root","up","from","dirname","next","cur","join","exists","pkg","loadJSON","Plugin","constructor","options","_base","version","valid","alreadyLoaded","children","_debug","default","warned","load","type","tag","Error","inspect","pjson","pjsonPath","isProd","files","warn","oclif","hooks","mapValues","i","manifest","_manifest","Boolean","ignoreManifest","errorOnManifestCreate","commands","entries","map","id","c","findCommand","must","sort","a","b","topics","commandsDir","tsPath","commandIDs","globby","globbyPath","resolve","paths","__dirname","error","patterns","ids","sync","cwd","file","parse","dir","split","command","length","filter","f","opts","fetch","search","cmd","run","values","find","m","code","plugin","readManifest","dotfile","process","env","OCLIF_NEXT_VERSION","emitWarning","Command","toCached","scope","addErrorScope","reduce","err","detail","compact"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst errors_1 = require(\"@oclif/errors\");\nconst path = require(\"path\");\nconst util_1 = require(\"util\");\nconst command_1 = require(\"./command\");\nconst debug_1 = require(\"./debug\");\nconst ts_node_1 = require(\"./ts-node\");\nconst util_2 = require(\"./util\");\nconst ROOT_INDEX_CMD_ID = '';\nconst _pjson = require('../package.json');\nconst hasManifest = function (p) {\n    try {\n        require(p);\n        return true;\n    }\n    catch (_a) {\n        return false;\n    }\n};\nfunction topicsToArray(input, base) {\n    if (!input)\n        return [];\n    base = base ? `${base}:` : '';\n    if (Array.isArray(input)) {\n        return input.concat(util_2.flatMap(input, t => topicsToArray(t.subtopics, `${base}${t.name}`)));\n    }\n    return util_2.flatMap(Object.keys(input), k => {\n        input[k].name = k;\n        return [Object.assign(Object.assign({}, input[k]), { name: `${base}${k}` })].concat(topicsToArray(input[k].subtopics, `${base}${input[k].name}`));\n    });\n}\n// eslint-disable-next-line valid-jsdoc\n/**\n * find package root\n * for packages installed into node_modules this will go up directories until\n * it finds a node_modules directory with the plugin installed into it\n *\n * This is needed because of the deduping npm does\n */\nasync function findRoot(name, root) {\n    // essentially just \"cd ..\"\n    function* up(from) {\n        while (path.dirname(from) !== from) {\n            yield from;\n            from = path.dirname(from);\n        }\n        yield from;\n    }\n    for (const next of up(root)) {\n        let cur;\n        if (name) {\n            cur = path.join(next, 'node_modules', name, 'package.json');\n            // eslint-disable-next-line no-await-in-loop\n            if (await util_2.exists(cur))\n                return path.dirname(cur);\n            try {\n                // eslint-disable-next-line no-await-in-loop\n                const pkg = await util_2.loadJSON(path.join(next, 'package.json'));\n                if (pkg.name === name)\n                    return next;\n            }\n            catch (_a) { }\n        }\n        else {\n            cur = path.join(next, 'package.json');\n            // eslint-disable-next-line no-await-in-loop\n            if (await util_2.exists(cur))\n                return path.dirname(cur);\n        }\n    }\n}\nclass Plugin {\n    // eslint-disable-next-line no-useless-constructor\n    constructor(options) {\n        this.options = options;\n        // static loadedPlugins: {[name: string]: Plugin} = {}\n        this._base = `${_pjson.name}@${_pjson.version}`;\n        this.valid = false;\n        this.alreadyLoaded = false;\n        this.children = [];\n        // eslint-disable-next-line new-cap\n        this._debug = debug_1.default();\n        this.warned = false;\n    }\n    async load() {\n        this.type = this.options.type || 'core';\n        this.tag = this.options.tag;\n        const root = await findRoot(this.options.name, this.options.root);\n        if (!root)\n            throw new Error(`could not find package.json with ${util_1.inspect(this.options)}`);\n        this.root = root;\n        this._debug('reading %s plugin %s', this.type, root);\n        this.pjson = await util_2.loadJSON(path.join(root, 'package.json'));\n        this.name = this.pjson.name;\n        const pjsonPath = path.join(root, 'package.json');\n        if (!this.name)\n            throw new Error(`no name in ${pjsonPath}`);\n        const isProd = hasManifest(path.join(root, 'oclif.manifest.json'));\n        if (!isProd && !this.pjson.files)\n            this.warn(`files attribute must be specified in ${pjsonPath}`);\n        // eslint-disable-next-line new-cap\n        this._debug = debug_1.default(this.name);\n        this.version = this.pjson.version;\n        if (this.pjson.oclif) {\n            this.valid = true;\n        }\n        else {\n            this.pjson.oclif = this.pjson['cli-engine'] || {};\n        }\n        this.hooks = util_2.mapValues(this.pjson.oclif.hooks || {}, i => Array.isArray(i) ? i : [i]);\n        this.manifest = await this._manifest(Boolean(this.options.ignoreManifest), Boolean(this.options.errorOnManifestCreate));\n        this.commands = Object.entries(this.manifest.commands)\n            .map(([id, c]) => (Object.assign(Object.assign({}, c), { load: () => this.findCommand(id, { must: true }) })));\n        this.commands.sort((a, b) => {\n            if (a.id < b.id)\n                return -1;\n            if (a.id > b.id)\n                return 1;\n            return 0;\n        });\n    }\n    get topics() {\n        return topicsToArray(this.pjson.oclif.topics || {});\n    }\n    get commandsDir() {\n        return ts_node_1.tsPath(this.root, this.pjson.oclif.commands);\n    }\n    get commandIDs() {\n        if (!this.commandsDir)\n            return [];\n        let globby;\n        try {\n            const globbyPath = require.resolve('globby', { paths: [this.root, __dirname] });\n            globby = require(globbyPath);\n        }\n        catch (error) {\n            this.warn(error, 'not loading commands, globby not found');\n            return [];\n        }\n        this._debug(`loading IDs from ${this.commandsDir}`);\n        const patterns = [\n            '**/*.+(js|ts|tsx)',\n            '!**/*.+(d.ts|test.ts|test.js|spec.ts|spec.js)?(x)',\n        ];\n        const ids = globby.sync(patterns, { cwd: this.commandsDir })\n            .map(file => {\n            const p = path.parse(file);\n            const topics = p.dir.split('/');\n            const command = p.name !== 'index' && p.name;\n            // support src/commands/index as a \"root\" command\n            if (!command && this.type === 'core' && p.dir.length === 0 && p.name === 'index')\n                return ROOT_INDEX_CMD_ID;\n            return [...topics, command].filter(f => f).join(':');\n        });\n        this._debug('found commands', ids);\n        return ids;\n    }\n    findCommand(id, opts = {}) {\n        const fetch = () => {\n            if (!this.commandsDir)\n                return;\n            const search = (cmd) => {\n                if (typeof cmd.run === 'function')\n                    return cmd;\n                if (cmd.default && cmd.default.run)\n                    return cmd.default;\n                return Object.values(cmd).find((cmd) => typeof cmd.run === 'function');\n            };\n            const p = require.resolve(path.join(this.commandsDir, ...id.split(':')));\n            this._debug('require', p);\n            let m;\n            try {\n                m = require(p);\n            }\n            catch (error) {\n                if (!opts.must && error.code === 'MODULE_NOT_FOUND')\n                    return;\n                throw error;\n            }\n            const cmd = search(m);\n            if (!cmd)\n                return;\n            cmd.id = id;\n            cmd.plugin = this;\n            return cmd;\n        };\n        const cmd = fetch();\n        if (!cmd && opts.must)\n            errors_1.error(`command ${id} not found`);\n        return cmd;\n    }\n    async _manifest(ignoreManifest, errorOnManifestCreate = false) {\n        const readManifest = async (dotfile = false) => {\n            try {\n                const p = path.join(this.root, `${dotfile ? '.' : ''}oclif.manifest.json`);\n                const manifest = await util_2.loadJSON(p);\n                if (!process.env.OCLIF_NEXT_VERSION && manifest.version.split('-')[0] !== this.version.split('-')[0]) {\n                    process.emitWarning(`Mismatched version in ${this.name} plugin manifest. Expected: ${this.version} Received: ${manifest.version}\\nThis usually means you have an oclif.manifest.json file that should be deleted in development. This file should be automatically generated when publishing.`);\n                }\n                else {\n                    this._debug('using manifest from', p);\n                    return manifest;\n                }\n            }\n            catch (error) {\n                if (error.code === 'ENOENT') {\n                    if (!dotfile)\n                        return readManifest(true);\n                }\n                else {\n                    this.warn(error, 'readManifest');\n                }\n            }\n        };\n        if (!ignoreManifest) {\n            const manifest = await readManifest();\n            if (manifest)\n                return manifest;\n        }\n        return {\n            version: this.version,\n            // eslint-disable-next-line array-callback-return\n            commands: this.commandIDs.map(id => {\n                try {\n                    return [id, command_1.Command.toCached(this.findCommand(id, { must: true }), this)];\n                }\n                catch (error) {\n                    const scope = 'toCached';\n                    if (Boolean(errorOnManifestCreate) === false)\n                        this.warn(error, scope);\n                    else\n                        throw this.addErrorScope(error, scope);\n                }\n            })\n                .filter((f) => Boolean(f))\n                .reduce((commands, [id, c]) => {\n                commands[id] = c;\n                return commands;\n            }, {}),\n        };\n    }\n    warn(err, scope) {\n        if (this.warned)\n            return;\n        if (typeof err === 'string')\n            err = new Error(err);\n        process.emitWarning(this.addErrorScope(err, scope));\n    }\n    addErrorScope(err, scope) {\n        err.name = `${err.name} Plugin: ${this.name}`;\n        err.detail = util_2.compact([err.detail, `module: ${this._base}`, scope && `task: ${scope}`, `plugin: ${this.name}`, `root: ${this.root}`, 'See more details with DEBUG=*']).join('\\n');\n        return err;\n    }\n}\nexports.Plugin = Plugin;\n"]},"metadata":{},"sourceType":"script"}